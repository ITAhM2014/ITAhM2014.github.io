<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		
		<title>List @ ITAhM</title>
		
		<style>
@import "css/itahm.css";

body {
	position: fixed; top: 0; right: 0; bottom: 0; left: 0;
	margin: 0; padding: 0;
}

article {
	display: flex;
	flex-direction: column;
	margin: auto;
	height: 99%;
}

aside {
	margin: 1em 0;
	display: flex;
	justify-content: space-between;
}

#list {
	flex: 1;
	background-color: #fff;
	overflow-y: auto;
}

header {
	background-color: #000;
	color: #fff;
	font-weight: bold; text-shadow: 0 1px 1px rgba(0, 0, 0, 0.1);
	border-bottom: 4px solid #92a7af;
	border-radius: 3px 3px 0 0;
	padding: 0.5em 0;
	text-shadow: 1px 1px 1px #00f;
}

#header img {
	width: 24px; height: 24px;
}

#header >li {
	position: relative;
	display: flex; align-items: center; justify-content: center;
}

#header >li:nth-child(1) {
	position: relative;
}

#sort::after {
	content: "▲";
	cursor: pointer;
	position: absolute; right: 3px;
}

#sort.reverse::after {
	content: "▼";
}

#header >li:not(:last-child) {
	border-right-color: #ddd;
}

aside input,
aside select {
	padding: .5em;
}

form input[type="text"] {
	flex: 1;
	min-width: 0;
}

nav {
	display: flex;
	align-items: center;
}

nav> div {
	margin-right: 5px;
}

nav >img {
	cursor: pointer;
}

ul {
	margin: 0; padding: 0;
	list-style: none;
	display: flex;
}

li {
	border: 1px solid transparent;
	padding: 0.5em;
	width: 120px;
	box-sizing: border-box;
}

#list li {
	color: #373d3f;
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}

li:nth-child(1) {
	flex: none;
	width: 4em;
}
/*
li:nth-child(1) >img {
	display: block;
	margin: auto;
	width: 24px; height: 24px;
	vertical-align: middle;
}
*/
li:nth-child(2) {
	width: 200px;
}

li:nth-child(3) {
	width: 180px;
}

li:nth-child(4) {
	width: 100px;
}

li:last-child {
	flex: 1;
}

label {
	color: #fff;
}

#list> ul {
	border-bottom: 1px solid #c1c3d1;
	padding: 0.5em;
	cursor: pointer;
}

#list> ul >li:first-child {
	background: center no-repeat;
	background-size: 24px;
}


#list> ul[data-normal] >li:first-child {
	background-image: url(img/normal.png);
}

#list> ul[data-critical] >li:first-child {
	background-image: url(img/siren.png);
}

#list> ul[data-shutdown] >li:first-child {
	background-image: url(img/warning.png);
}

#list> ul[data-disabled] >li:first-child {
	background-image: url(img/disabled.png);
}

#list> ul[data-disabled] {
	color: #999;
}

#list> ul:nth-child(odd) {
	background-color: #ebebeb;
}

#list> ul> li:nth-child(3) {
	background-size: 24px 24px;
	background-repeat: no-repeat;
	background-position: left center;
}

#list> ul> li:nth-child(3)::before {
	content: attr(data-type);
	display: inline-block;
	margin-left: 30px;
}

#list >ul.selected {
	background-color: #ffc;
}

#count {
	font-size: 30px; font-weight: bold; color: #fff;
	display: inline-block;
	margin: 0 30px;
}

#action >img,
.action >img {
	width: 1.5em; height: 1.5em;
	margin: 0 1em;
}

#action:not(.selected),
#action:not(.snmp) >.snmp {
	display: none;
}

.selector {
	overflow: visible;
}

.selector div {
	position: absolute; top: 100%; left: 0; width: 100%;
	border: 1px inset gray;
	box-sizing: border-box;
	z-index: 1;
	background-color: #fff;
}

.selector:not(:focus) div {
	display: none;
}

.selector p {
	padding: 3px; margin: 0;
	text-align: center;
}

.selector p:not(:last-child) {
	border-bottom: 1px solid #ccc;
}

.selector img {
	pointer-events: none;
}

@keyframes grow {
	from {
		transform: scale(1);
	}
	to {
		transform: scale(1.5);
	}
}

#list >ul.hidden,
body.keyword #list> ul:not(.keyword),
body.normal #list> ul:not([data-normal]),
body.critical #list> ul:not([data-critical]),
body.shutdown #list> ul:not([data-shutdown]),
body.disabled #list> ul:not([data-disabled]) {
	display: none;
}

		</style>
		
		<script>
// static function
const REGEXP_IPV4 = new RegExp("^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\."
	+ "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\."
	+ "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\."
	+ "(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$");

function IP2Int(s) {
	const o = REGEXP_IPV4.exec(s);
	
	if(o === null || o.length != 5) return 0xffffffff;
	
	var n = 0;
	for(let i=1; i<5; i++) {
		n <<= 8;
		n |= o[i];
	}
	
	return n >>> 0;
}
		</script>
		
		<script>
function onEdit() {
	top.showDialog.call(window, "/device_dialog.html", window.selectedID);
}

function onSetAlarm(){
	top.showDialog.call(window, "/critical_dialog.html", window.selectedID);
}

function onMap() {
	window.location.href = "/map_edit.html?"+ encodeURI(window.selectedID);
}

function onShowStatus() {
	top.showStatus(window.selectedID);
}

function initialize() {
	if ("custom" in top.config) {
		var customs = top.config.custom;
		
		if (customs) {
			let df = document.createDocumentFragment();
			
			window.customs = customs.split(",");
			
			forEach(window.customs, function (custom) {
				df.appendChild(document.createElement("li")).textContent = custom;
			});
			
			window.header.insertBefore(df, window.header.lastElementChild);
		}
	}
	
	const
		df = document.createDocumentFragment(),
		ipList = Object.keys(window.node).sort(function (a, b) {
			const
				ipA = window.node[a].base.ip,
				ipB = window.node[b].base.ip;
			
			if (ipA && ipB) {
				return IP2Int(ipA) - IP2Int(ipB);
			}
			else if (ipA) {
				return 1;
			}
			else {
				return 2;
			}
		});

	for (let i=0, _i=ipList.length, id, node; i<_i; i++) {
		id = ipList[i];
	
		node = window.node[id];
	
		if (node.base.type === "group" || node.base.type === "application") {
			continue;
		}
		
		df.appendChild(createRow(id, node.base, node.monitor));
	}
	
	list.appendChild(df);
	
	document.body.classList.remove("loading");

	document.getElementById("count").textContent = count();

	initLabel();
}

function createRow(id, base, monitor) {
	var
		row = document.createElement("ul"),
		type, labels, label;
	
	row.appendChild(document.createElement("li")); // N.1
	
	row.appendChild(document.createElement("li")).textContent = base.ip || ""; // N.2
	
	type = document.createElement("li");
	type.dataset.type = base.type;
	type.style.backgroundImage = "url('"+ getIcon(base.type).src +"')";
	
	row.appendChild(type); // N.3
	
	row.appendChild(document.createElement("li")).textContent = monitor && monitor.protocol || ""; // N.4
	
	if (window.customs) {
		forEach(window.customs, function (custom) {
			row.appendChild(document.createElement("li")).textContent = base.custom[custom] || "";
		});
	};
	
	row.appendChild(document.createElement("li")).textContent = base.name; // N.0

	row.id = id;
	
	if (base.label) {
		labels = base.label.split(",");
		
		for (var i=0, length=labels.length; i<length; i++) {
			label = labels[i];
			
			if (!(label in window.labelMap)) {
				window.labelMap[label] = [];
			}

			window.labelMap[label].push(row);
		}
	}
	else {
		window.labelMap[""].push(row);
	}
	
	if (monitor) {
		if (!monitor.status) {
			row.dataset.shutdown = true;
		}
		else if ("critical" in monitor && !monitor.critical) {
			row.dataset.critical = true;
		}
		else {
			row.dataset.normal = true;
		}
	}
	else {
		row.dataset.disabled = true;
	}
	
	row.onclick = onSelectDevice.bind(row, id, monitor);
	
	return row;
}

function selectDevice(row, id, monitor) {
	if (window.selected) {
		window.selected.classList.remove("selected");
	}
	
	if (row) {
		window.selected = row;
		window.selectedID = id;
		
		window.action.className = "selected";
		
		if (monitor && monitor.protocol === "snmp") {
			window.action.classList.add("snmp");
		}
		
		row.classList.add("selected");
	}
	else {
		window.selected = undefined;
		window.action.className = "";
	}
}

function onSelectDevice(id, monitor) {
	selectDevice(this, id, monitor);	
}

function initLabel() {
	var df = document.createDocumentFragment(),
		option = document.createElement("option");

	for (var label in window.labelMap) {
		option = document.createElement("option");
		
		option.text = label;
		
		df.appendChild(option);
	}
	
	window.label.insertBefore(df, window.label.firstChild);
}

// 선택 초기화 (상태별로 필터링)
function onSelectStatus (src, className) {
	selectDevice();
	
	document.body.classList.remove("normal", "critical", "shutdown", "disabled");
	
	if (className) {
		document.body.classList.add(className);
	}
	
	icon.src = src;
	
	window.selector.blur();
}

function onSave() {
	var devices = {},
		etc = [],
		row = [],
		labels, label, device;
	
	row[0] = "label,name,type,ip";
	
	if (window.customs) {
		forEach(window.customs, function (custom) {
			row[0] += (","+ custom);
		});
	}
	
	top.forEachDB("device", function (id, device) {
		if (device.group) {
			return;
		}
		
		if (device.label) {
			label = device.label.split(",")[0];
			
			if (!(label in devices)) {
				devices[label] = [];
			}
			
			devices[label][devices[label].length] = device;
		}
		else {
			etc[etc.length] = device;
		}
	});
	
	labels = Object.keys(devices).sort(function (a, b) {
		return a > b? 1: -1;
	});
	
	for (var i=0, _i=labels.length; i<_i; i++) {
		label = labels[i];
		
		forEach(devices[label], function (device) {
			var columns = [label, device.name, device.type, device.ip];
			
			if (window.customs) {
				forEach(window.customs, function (custom) {
					columns[columns.length] = device[custom] || "";
				});
			}
			
			row[row.length] = columns.join(",");
		});
	}
	
	forEach(etc, function (device) {
		var columns = ["", device.name, device.type, device.ip];
		
		if (window.customs) {
			forEach(window.customs, function (custom) {
				columns[columns.length] = device[custom] || "";
			});
		}
		
		row[row.length] = columns.join(",");
	});
	
	ITAhM.util.download(new Blob([row.join("\n")] ,{
		type: "text/csv;charset=utf-8;"
	}), "list.csv");
}

function count() {
	var count = 0;

	[].forEach.call(window.list.children, function (row) {
		if (row.offsetHeight > 0) {
			count++;
		}
	});

	return count;
}


function forEach(a, f) {
	for (var i=0, _i=a.length; i<_i; i++) {
		f(a[i]);
	}
}

		</script>
		
	</head>
	
	<body class="loading">
		<article>
			<aside>
				<nav>
					<i id="count"></i>
					<div>
						<select id="label">
							<optgroup>
								<option value="">미분류
							</optgroup>
							<optgroup>
								<option selected>모두 보기
							</optgroup>
						</select>
					</div>
					<div class="action">
						<img id="save" src="img/save2.png" title="CSV 파일로 저장">
					</div>
					<div id="action">
						<img id="map" src="img/location.png" title="구성도에서 장비보기">
						<img id="edit" src="img/edit.png" title="장비의 정보 편집">
						<img id="status" class="snmp" src="img/chart.png" title="장비의 상태 보기">
						<img id="alarm" class="snmp" src="img/alarm.png" title="장비의 성능 임계 설정">
					</div>
				</nav>
				<form>
					<input type="text" name="keyword" placeholder="IP, Type, Name">
					<input type="submit" value="찾기">
					<input type="reset" value="초기화">
				</form>
			</aside>
			
			<header>
				<ul id="header">
					<li class="selector" tabindex="0">
						<img id="icon" src="img/all.png">
						<div>
							<p title="장애 장비 보기" id="shutdown">
								<img src="img/warning.png">
							</p>
							<p title="임계 장비 보기" id="critical">
								<img src="img/siren.png">
							</p>
							<p title="정상 장비 보기" id="normal">
								<img src="img/normal.png">
							</p>
							<p title="비활성 장비 보기" id="disabled">
								<img src="img/disabled.png">
							</p>
							<p title="모든 장비 보기" id="all">
								<img src="img/all.png">
							</p>
						</div>
					<li id="sort">IP
					<li>Type
					<li>Monitor
					<li>Name
				</ul>
			</header>
			
			<div id="list"></div>
		</article>
		
		<div class="bg_loading"></div>
		
		<script src="js/ITAhM.js"></script>
		<script src="js/object.js"></script>
		<script>

var 
	header = document.getElementById("header"),
	label = document.getElementById("label"),
	list = document.getElementById("list"),
	selector = document.querySelector(".selector"),
	icon = document.getElementById("icon"),
	action = document.getElementById("action"),
	labelMap = {
		"": []
	},
	customs, selected;

label.onchange = function () {
	const
		df = document.createDocumentFragment(),
		label = this.value;
	
	document.body.classList.add("loading");
	
	if (window.label.selectedIndex === window.label.options.length -1) {
		for (let row; row = window.list.firstElementChild;) {
			df.appendChild(row).classList.remove("hidden");
		}
	}
	else {
		// 선택 초기화
		selectDevice();

		for (let row; row = window.list.firstElementChild;) {
			df.appendChild(row).classList[window.labelMap[label].indexOf(row) == -1? "add": "remove"]("hidden");
		}
	}
	
	window.list.appendChild(df);

	document.body.classList.remove("loading");

	document.getElementById("count").textContent = count();
};

document.getElementById("shutdown").onclick = onSelectStatus.bind(window, "img/warning.png", "shutdown");
document.getElementById("critical").onclick = onSelectStatus.bind(window, "img/siren.png", "critical");
document.getElementById("normal").onclick = onSelectStatus.bind(window, "img/normal.png", "normal");
document.getElementById("disabled").onclick = onSelectStatus.bind(window, "img/disabled.png", "disabled");
document.getElementById("all").onclick = onSelectStatus.bind(window, "img/all.png", "");
document.getElementById("save").onclick = onSave;
document.getElementById("map").onclick = onMap;
document.getElementById("edit").onclick = onEdit;
document.getElementById("alarm").onclick = onSetAlarm;
document.getElementById("status").onclick = onShowStatus;

document.getElementById("sort").onclick = function (e) {
	const
		reverse = this.classList.toggle("reverse"),
		df = document.createDocumentFragment();

	[].slice.call(window.list.children).sort(reverse?
		function (a, b) {
			return b.children[1].textContent.localeCompare(a.children[1].textContent);
		}:
		function (a, b) {
			return a.children[1].textContent.localeCompare(b.children[1].textContent);
		}).forEach(function (e) {
			df.appendChild(e);
		});

	window.list.appendChild(df);
};

(function (form) {
	// 키워드로 필터링
	form.onsubmit = function (e) {
		e.preventDefault();
		
		document.body.classList.add("loading", "keyword");

		// 선택 취소
		selectDevice();
		
		const keyword = form.elements["keyword"].value;

		if (!keyword) {
			resetKeyWord();

			return;
		}

		const df = document.createDocumentFragment();
		
		for (let row, cols; row = window.list.firstElementChild;) {
			cols = row.children;

			df.appendChild(row);

			for (var i=0, length=cols.length; i<length; i++) {
				row.classList.remove("keyword");

				if (cols[i].textContent.indexOf(keyword) !== -1) {
					row.classList.add("keyword");
					
					break;
				}
			}
		}
		
		window.list.appendChild(df);

		document.body.classList.remove("loading");

		document.getElementById("count").textContent = count();
	};

	form.onreset =  function (e) {
		e.preventDefault();
	
		form.elements["keyword"].value = "";

		resetKeyWord();
	};

	function resetKeyWord() {
		const df = document.createDocumentFragment();

		document.body.classList.add("loading");
		
		for (let row; row = window.list.firstElementChild;) {
			df.appendChild(row).classList.remove("keyword");
		}

		document.body.classList.remove("keyword");

		window.list.appendChild(df);

		document.body.classList.remove("loading");

		document.getElementById("count").textContent = count();
	}

	window.getIcon = function (type) {
		return top.config.icon && top.config.icon[type] || top.store.icon[type];
	};

}) (document.querySelector("form"));

top.postRequest({
	command: "node"
}, function () {
	switch (this.status) {
	case 200:
		window.node = JSON.parse(this.responseText);

		initialize();

		break;
	default:
		const message = this.responseText? JSON.parse(this.responseText).error: "";

		if (message) {
			console.log(message);
		}

		alert(top.getMessage(this.status));
	}
});

</script>
	
	</body>
	
</html>